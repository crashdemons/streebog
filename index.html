<!DOCTYPE html>

<html>
    <head>
        <title>streebog-wasm example</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
<script src="./streebog-wasm-dist/streebog-wasm.js"></script>
<script>
window.streebog_wasm = null;
    
function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}
function debugClear(){
     var results = document.getElementById('results');
     results.innerHTML="";
}
function debug(s){
    var results = document.getElementById('results')
    console.log(s)
    
    var entry = document.createElement('div');
    entry.innerText=s;
    entry.innerHTML+="<br />";
    
    results.appendChild(entry);
}

async function debugBuffer(prefix,pBuffer,nBufLen){
    const resultView = new Uint8Array(streebog_wasm.module.HEAP8.buffer, pBuffer, nBufLen);
    const result = new Uint8Array(resultView);
    await debug("  "+prefix+" = "+buf2hex(result.buffer));
}
function clickHash(){
    var input = document.getElementById('input');
    var sizeSelect = document.getElementById('size');
    var digestSize = +(sizeSelect.value);
    var inputText = input.value;
    debugClear();
    if(window.streebog_wasm===null){
        debug("module not ready");
    }else{
        debug("module ready");
        hashStringDebug(inputText,digestSize);
    }
}
async function hashStringDebug(inputText,digestSize){
    debug("Streebog-wasm library version: "+streebog_wasm.version());
    
    ctx = streebog_wasm.init(digestSize);
    debug("*Initialized hash context = "+ctx+", digest-size = "+digestSize);
    
    
    //var inputText = "test";
    var inBufLen = inputText.length;
    debug(" input string = "+inputText+" (length:"+inBufLen+")");
    
    var inBuffer = streebog_wasm.create_buffer(inBufLen);
    debug(" created buffer for input = "+inBuffer);
    await debugBuffer("Unassigned Input Buffer",inBuffer,inBufLen);
    
    var enc = new TextEncoder()
    var inputArray = enc.encode(inputText);
    streebog_wasm.module.HEAP8.set(inputArray, inBuffer);
    debugBuffer("Assigned Input Buffer",inBuffer,inBufLen);
    
    
    debug("*Updating context with input buffer");
    streebog_wasm.update(ctx, inBuffer, inBufLen);
    
    
    var outBufLen = digestSize/8;
    var outBuffer = streebog_wasm.create_buffer(outBufLen);
    debug(" allocated output buffer = "+outBuffer+" (length: "+outBufLen+")");
    debugBuffer("Unassigned Output Buffer",outBuffer,outBufLen);
    
    streebog_wasm.final(ctx,outBuffer);
    debug("*Finalizing hash to output buffer.");
    
    const resultView = new Uint8Array(streebog_wasm.module.HEAP8.buffer, outBuffer, outBufLen);
    const result = new Uint8Array(resultView);
    debugBuffer("Result",outBuffer,outBufLen);
    
    debug("*Cleaning up");
    streebog_wasm.cleanup(ctx);
    streebog_wasm.destroy_buffer(inBuffer);
    streebog_wasm.destroy_buffer(outBuffer);
    
    debug("*Done");
}

  createStreebogModule().then(async module => {
    const api = {
      module: module,
      version: module.cwrap('version', 'number', []),
      
      create_buffer: module.cwrap('create_buffer', 'number', ['number']),
      destroy_buffer: module.cwrap('destroy_buffer', '', ['number']),
      
      init: module.cwrap('streebog_init', 'number', ['number']),
      update: module.cwrap('streebog_update', '', ['number','number','number']),
      final: module.cwrap('streebog_final', '', ['number','number']),
      cleanup: module.cwrap('streebog_cleanup', '', ['number']),
    };
    window.streebog_wasm = api;
  });
</script>

    </head>
    <body>
        <input type="text" id="input" value="test"><select id="size"><option value="256">Streebog-256</option><option value="512" selected="selected">Streebog-512</option></select><button onclick="clickHash()">Calculate Hash</button>
        <hr>
        <div id="results"></div>
        <hr>
        <div>Known Streebog-512 result for "test": 7200bf5dea560f0d7960d07fdc8874ad9f3b86ece2e45f5502ae2e176f2c928e0e581152281f5aee818318bed7cbe6aa69999589234723ceb33175598365b5c8</div>
        <div>Known Streebog-256 result for "test": 12a50838191b5504f1e5f2fd078714cf6b592b9d29af99d0b10d8d02881c3857</div>
    </body>
</html>

