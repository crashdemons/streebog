<!DOCTYPE html>

<html>
    <head>
        <title>streebog-wasm example</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
<script src="./streebog-wasm-dist/streebog-wasm.js"></script>
<script>
window.streebog_wasm = null;
    
function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}
function debugClear(){
     var results = document.getElementById('results');
     results.innerHTML="";
}
function debug(s){
    var results = document.getElementById('results')
    console.log(s)
    
    var entry = document.createElement('div');
    entry.innerText=s;
    entry.innerHTML+="<br />";
    
    results.appendChild(entry);
}
function clickHash(){
    var input = document.getElementById('input');
    var inputText = input.value;
    debugClear();
    if(window.streebog_wasm===null){
        debug("module not ready");
    }else{
        debug("module ready");
        hashStringDebug(inputText);
    }
}
function hashStringDebug(inputText){
    debug("Streebog-wasm library version: "+streebog_wasm.version());
    
    ctx = streebog_wasm.init(512);
    debug("*Initialized hash context = "+ctx);
    
    
    //var inputText = "test";
    var inBufLen = inputText.length;
    debug(" input string = "+inputText+" (length:"+inBufLen+")");
    
    var inBuffer = streebog_wasm.create_buffer(inBufLen);
    Module.HEAP8.set(inputText, inBuffer);
    debug(" created buffer for input = "+inBuffer);
    
    
    debug("*Updating context with input buffer");
    streebog_wasm.update(ctx, inBuffer, inBufLen);
    
    
    var outBufLen = 64;
    var outBuffer = streebog_wasm.create_buffer(outBufLen);
    debug(" allocated output buffer = "+outBuffer+" (length: "+outBufLen+")");
    
    streebog_wasm.final(ctx,outBuffer);
    debug("*Finalizing hash to output buffer.");
    
    const resultView = new Uint8Array(Module.HEAP8.buffer, outBuffer, outBufLen);
    const result = new Uint8Array(resultView);
    
    debug(" Result = "+buf2hex(result.buffer));
    
    debug("*Cleaning up");
    streebog_wasm.cleanup(ctx);
    streebog_wasm.destroy_buffer(inBuffer);
    streebog_wasm.destroy_buffer(outBuffer);
    
    debug("*Done");
}

  Module.onRuntimeInitialized = async _ => {
    const api = {
      version: Module.cwrap('version', 'number', []),
      
      create_buffer: Module.cwrap('create_buffer', 'number', ['number']),
      destroy_buffer: Module.cwrap('destroy_buffer', '', ['number']),
      
      init: Module.cwrap('streebog_init', 'number', ['number']),
      update: Module.cwrap('streebog_update', '', ['number','number','number']),
      final: Module.cwrap('streebog_final', '', ['number','number']),
      cleanup: Module.cwrap('streebog_cleanup', '', ['number']),
    };
    window.streebog_wasm = api;
  };
</script>

    </head>
    <body>
        <input type="text" id="input" value="test"><button onclick="clickHash()">Calculate Streebog Hash</button>
        <hr>
        <div id="results"></div>
        <hr>
        <div>Example known result for "test": 7200bf5dea560f0d7960d07fdc8874ad9f3b86ece2e45f5502ae2e176f2c928e0e581152281f5aee818318bed7cbe6aa69999589234723ceb33175598365b5c8</div>
    </body>
</html>
